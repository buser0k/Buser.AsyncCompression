name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOTNET_VERSION: '8.0.x' # Using .NET 8 for compatibility
  CAKE_VERSION: '3.0.0'

permissions:
  contents: write
  packages: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache .NET packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Install Cake
      run: |
        dotnet tool install --global Cake.Tool --version ${{ env.CAKE_VERSION }}

    - name: Restore dependencies
      run: dotnet cake build.cake --target=Restore

    - name: Build solution
      run: dotnet cake build.cake --target=Build

    - name: Run tests
      run: dotnet cake build.cake --target=Test

    - name: Generate test results
      run: dotnet cake build.cake --target=TestResults

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: test-results/

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache .NET packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Install Cake
      run: |
        dotnet tool install --global Cake.Tool --version ${{ env.CAKE_VERSION }}

    - name: Restore dependencies
      run: dotnet cake build.cake --target=Restore

    - name: Build solution
      run: dotnet cake build.cake --target=Build

    - name: Run tests
      run: dotnet cake build.cake --target=Test

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache .NET packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Install Cake
      run: |
        dotnet tool install --global Cake.Tool --version ${{ env.CAKE_VERSION }}

    - name: Restore dependencies
      run: dotnet cake build.cake --target=Restore

    - name: Build solution
      run: dotnet cake build.cake --target=Build

    - name: Run tests
      run: dotnet cake build.cake --target=Test

  publish:
    needs: [build-and-test, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install Cake
      run: |
        dotnet tool install --global Cake.Tool --version ${{ env.CAKE_VERSION }}

    - name: Determine version bump type
      id: version
      run: |
        # Analyze all commits in this push (e.g. all commits that went into the merge)
        COMMITS=$(git log --format=%B ${{ github.event.before }}..${{ github.sha }})

        echo "Commits considered for version bump:"
        echo "$COMMITS"

        # Determine bump type based on Conventional Commits across the whole range:
        # 1) major – any breaking change markers
        # 2) minor – any feat/feature commits
        # 3) patch – everything else (fix, refactor, docs, chore, etc.)

        if echo "$COMMITS" | grep -qiE '(BREAKING CHANGE|breaking change|breaking:|BREAKING:|(^|[[:space:]])major(:|[[:space:]))'; then
          echo "bump=major" >> $GITHUB_OUTPUT
          echo "type=major" >> $GITHUB_OUTPUT
          echo "Detected major version bump (breaking change)"
        elif echo "$COMMITS" | grep -qiE '^(feat|feature)(\(.+\))?:'; then
          echo "bump=minor" >> $GITHUB_OUTPUT
          echo "type=minor" >> $GITHUB_OUTPUT
          echo "Detected minor version bump (feature)"
        else
          echo "bump=patch" >> $GITHUB_OUTPUT
          echo "type=patch" >> $GITHUB_OUTPUT
          echo "Detected patch version bump (default)"
        fi

    - name: Increment version and publish
      run: |
        if [ -n "$NUGET_API_KEY" ]; then
          echo "Incrementing version (${{ steps.version.outputs.bump }}) and publishing..."
          dotnet cake build.cake --target=Publish --nugetApiKey="$NUGET_API_KEY" --versionBump="${{ steps.version.outputs.bump }}"
        else
          echo "NUGET_API_KEY not set, skipping publish"
          echo "This is expected for forks and when secret is not configured"
        fi
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

    - name: Get new version
      id: new_version
      run: |
        VERSION=$(grep -oP '<Version>\K[^<]+' Buser.AsyncCompression/Buser.AsyncCompression.csproj | head -1)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "New version: $VERSION"

    - name: Commit version update
      if: env.NUGET_API_KEY != '' && steps.new_version.outputs.version != ''
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add Buser.AsyncCompression/Buser.AsyncCompression.csproj
        if git diff --staged --quiet; then
          echo "No version changes to commit"
        else
          git commit -m "chore: bump version to ${{ steps.new_version.outputs.version }} [skip ci]" || exit 0
          git push || exit 0
        fi

    - name: Create Release
      if: env.NUGET_API_KEY != ''
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.new_version.outputs.version }}
        name: Release v${{ steps.new_version.outputs.version }}
        draft: false
        prerelease: false
        generate_release_notes: true
